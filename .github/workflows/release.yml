name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_discord:
        description: 'Test Discord notification (will be marked as [TEST])'
        required: false
        type: boolean
        default: false

concurrency: ${{ github.workflow }}-${{ github.ref }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Test Discord notification (no production environment required)
  test-discord:
    name: Test Discord Notification
    if: inputs.test_discord == true
    runs-on: ubuntu-latest
    steps:
      - name: Send test Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Check if webhook URL is configured
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::error::DISCORD_WEBHOOK_URL secret is not configured."
            exit 1
          fi
          
          # Create the Discord webhook payload
          PAYLOAD=$(jq -n \
            '{
              "username": "CRXJS Release Bot",
              "avatar_url": "https://crxjs.dev/logo.svg",
              "embeds": [{
                "title": "[TEST] Test Discord Notification",
                "description": "• This is a test notification to verify Discord webhook integration",
                "color": 2105893,
                "footer": {
                  "text": "[TEST] CRXJS Chrome Extension Tools"
                },
                "timestamp": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')
          
          # Send to Discord
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
          
          echo "Discord test notification sent successfully!"

  release:
    name: Release
    if: inputs.test_discord != true
    runs-on: ubuntu-latest
    environment: production
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup PNPM
        # You may pin to the exact commit or the version.
        # uses: pnpm/action-setup@646cdf48217256a3d0b80361c5a50727664284f2
        uses: pnpm/action-setup@v4
        with:
          # Version of PNPM to install
          version: 10.11.1
          # Where to store PNPM files
          # dest: # optional, default is ~/setup-pnpm
          # If specified, run `pnpm install`
          # run_install: true

      - name: Cache pnpm modules
        uses: actions/cache@v4
        env:
          cache-name: cache-pnpm-modules
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/package.json') }}
          restore-keys: ${{ runner.os }}-${{ env.cache-name }}-

      - name: Install dependencies
        run: pnpm install

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - if: steps.changesets.outputs.published == 'true'
        name: Notify Discord about new release
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PUBLISHED_PACKAGES: ${{ steps.changesets.outputs.publishedPackages }}
        run: |
          # Check if webhook URL is configured
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::warning::DISCORD_WEBHOOK_URL secret is not configured. Skipping Discord notification."
            exit 0
          fi
          
          # Parse the published packages and create a Discord message
          PACKAGES=$(echo "$PUBLISHED_PACKAGES" | jq -r '.[] | "• \(.name)@\(.version)"' 2>/dev/null || echo "• New packages published")
          
          # Create the Discord webhook payload
          PAYLOAD=$(jq -n \
            --arg description "$PACKAGES" \
            '{
              "username": "CRXJS Release Bot",
              "avatar_url": "https://crxjs.dev/logo.svg",
              "embeds": [{
                "title": "New packages have been published to npm",
                "description": $description,
                "color": 2105893,
                "footer": {
                  "text": "CRXJS Chrome Extension Tools"
                },
                "timestamp": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')
          
          # Send to Discord
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
          
          echo "Discord notification sent successfully!"
