name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_discord:
        description: 'Test Discord notification (will be marked as [TEST])'
        required: false
        type: boolean
        default: false

concurrency: ${{ github.workflow }}-${{ github.ref }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment: production
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup PNPM
        # You may pin to the exact commit or the version.
        # uses: pnpm/action-setup@646cdf48217256a3d0b80361c5a50727664284f2
        uses: pnpm/action-setup@v4
        with:
          # Version of PNPM to install
          version: 10.11.1
          # Where to store PNPM files
          # dest: # optional, default is ~/setup-pnpm
          # If specified, run `pnpm install`
          # run_install: true

      - name: Cache pnpm modules
        uses: actions/cache@v4
        env:
          cache-name: cache-pnpm-modules
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/package.json') }}
          restore-keys: ${{ runner.os }}-${{ env.cache-name }}-

      - name: Install dependencies
        run: pnpm install

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - if: steps.changesets.outputs.published == 'true' || inputs.test_discord == true
        name: Notify Discord about new release
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PUBLISHED_PACKAGES: ${{ steps.changesets.outputs.publishedPackages }}
          IS_TEST: ${{ inputs.test_discord == true }}
        run: |
          # Determine if this is a test run
          if [ "$IS_TEST" = "true" ]; then
            TEST_PREFIX="[TEST] "
            TITLE="${TEST_PREFIX}Test Discord Notification"
            PACKAGES="• This is a test notification to verify Discord webhook integration"
          else
            TEST_PREFIX=""
            TITLE="New packages have been published to npm"
            # Parse the published packages and create a Discord message
            PACKAGES=$(echo "$PUBLISHED_PACKAGES" | jq -r '.[] | "• \(.name)@\(.version)"' 2>/dev/null || echo "• New packages published")
          fi
          
          # Create the Discord webhook payload
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$PACKAGES" \
            --arg test_prefix "$TEST_PREFIX" \
            '{
              "username": "CRXJS Release Bot",
              "avatar_url": "https://crxjs.dev/logo.svg",
              "embeds": [{
                "title": $title,
                "description": $description,
                "color": 2105893,
                "footer": {
                  "text": ($test_prefix + "CRXJS Chrome Extension Tools")
                },
                "timestamp": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')
          
          # Send to Discord
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
          
          echo "Discord notification sent successfully!"
